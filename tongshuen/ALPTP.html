<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPTP 授时器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2a3a7c);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            background: rgba(30, 30, 50, 0.8);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-top: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4a5fc9;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #6c8cff;
            text-shadow: 0 0 10px rgba(108, 140, 255, 0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #a0a0d0;
        }
        
        .protocol-info {
            background: rgba(40, 40, 60, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .protocol-info h2 {
            color: #6c8cff;
            margin-bottom: 10px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 25px 0;
        }
        
        button {
            background: linear-gradient(to right, #4a5fc9, #6c8cff);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            text-align: center;
            font-size: 1.2rem;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(50, 50, 70, 0.7);
        }
        
        .signal-display {
            background: #0a0a1a;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            height: 200px;
            overflow: hidden;
            position: relative;
        }
        
        .signal-canvas {
            width: 100%;
            height: 100%;
            background: #0a0a1a;
        }
        
        .time-display {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 25px 0;
        }
        
        .time-card {
            background: rgba(40, 40, 60, 0.7);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            flex: 1;
            min-width: 150px;
        }
        
        .time-card h3 {
            color: #6c8cff;
            margin-bottom: 10px;
        }
        
        .time-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #a0d0ff;
        }
        
        .frame-data {
            background: rgba(40, 40, 60, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .frame-data h3 {
            color: #6c8cff;
            margin-bottom: 15px;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(100, 100, 150, 0.3);
        }
        
        .data-label {
            color: #a0a0d0;
        }
        
        .data-value {
            font-weight: bold;
            color: #a0d0ff;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 10px;
            border-radius: 3px;
        }
        
        .bit-0 { background-color: #4CAF50; }
        .bit-1 { background-color: #FF9800; }
        .bit-m { background-color: #F44336; }
        
        footer {
            margin-top: 30px;
            text-align: center;
            color: #8080c0;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
            
            .time-display {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ALPTP 授时器</h1>
            <p class="subtitle">抗干扰低速高精度授时协议 (Anti-interference Low-speed Precise Timing Protocol)</p>
        </header>
        
        <div class="protocol-info">
            <h2>协议概述</h2>
            <p>ALPTP 是一种专为低带宽、高干扰环境设计的精确授时协议。每帧传输长度为1分钟，包含完整的时间信息（年、月、日、星期、时、分）以及闰秒标志和校验。</p>
            <p>编码方式：0b0（300ms载波/700ms空闲）、0b1（700ms载波/300ms空闲）、m标志（1000ms载波，表示整分开始）</p>
        </div>
        
        <div class="controls">
            <button id="startBtn">开始授时</button>
            <button id="stopBtn" disabled>停止授时</button>
        </div>
        
        <div class="status" id="statusDisplay">
            等待开始授时...
        </div>
        
        <div class="signal-display">
            <canvas class="signal-canvas" id="signalCanvas"></canvas>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color bit-0"></div>
                <span>0b0 (300ms载波/700ms空闲)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bit-1"></div>
                <span>0b1 (700ms载波/300ms空闲)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bit-m"></div>
                <span>m标志 (1000ms载波)</span>
            </div>
        </div>
        
        <div class="time-display">
            <div class="time-card">
                <h3>当前时间</h3>
                <div class="time-value" id="currentTime">--:--:--</div>
            </div>
            <div class="time-card">
                <h3>下一帧开始</h3>
                <div class="time-value" id="nextFrameTime">--:--:--</div>
            </div>
            <div class="time-card">
                <h3>已接收帧数</h3>
                <div class="time-value" id="frameCount">0</div>
            </div>
        </div>
        
        <div class="frame-data">
            <h3>当前帧数据</h3>
            <div class="data-grid">
                <div class="data-item">
                    <span class="data-label">年：</span>
                    <span class="data-value" id="dataYear">--</span>
                </div>
                <div class="data-item">
                    <span class="data-label">月：</span>
                    <span class="data-value" id="dataMonth">--</span>
                </div>
                <div class="data-item">
                    <span class="data-label">日：</span>
                    <span class="data-value" id="dataDay">--</span>
                </div>
                <div class="data-item">
                    <span class="data-label">星期：</span>
                    <span class="data-value" id="dataWeekday">--</span>
                </div>
                <div class="data-item">
                    <span class="data-label">时：</span>
                    <span class="data-value" id="dataHour">--</span>
                </div>
                <div class="data-item">
                    <span class="data-label">分：</span>
                    <span class="data-value" id="dataMinute">--</span>
                </div>
                <div class="data-item">
                    <span class="data-label">闰秒标志：</span>
                    <span class="data-value" id="dataLeapSecond">--</span>
                </div>
                <div class="data-item">
                    <span class="data-label">CRC校验：</span>
                    <span class="data-value" id="dataCRC">--</span>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        ©2025 童顺 <admin@tongshun.tech>
    </footer>

    <script>
        // ALPTP 协议实现
        class ALPTPProtocol {
            constructor() {
                this.audioContext = null;
                this.oscillator = null;
                this.gainNode = null;
                this.isRunning = false;
                this.frameCount = 0;
                this.currentBitIndex = 0;
                this.currentFrameData = null;
                this.nextMinuteTimeout = null;
                this.animationId = null;
                
                // 初始化UI元素引用
                this.canvas = document.getElementById('signalCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.statusDisplay = document.getElementById('statusDisplay');
                this.currentTimeDisplay = document.getElementById('currentTime');
                this.nextFrameTimeDisplay = document.getElementById('nextFrameTime');
                this.frameCountDisplay = document.getElementById('frameCount');
                
                // 数据展示元素
                this.dataYear = document.getElementById('dataYear');
                this.dataMonth = document.getElementById('dataMonth');
                this.dataDay = document.getElementById('dataDay');
                this.dataWeekday = document.getElementById('dataWeekday');
                this.dataHour = document.getElementById('dataHour');
                this.dataMinute = document.getElementById('dataMinute');
                this.dataLeapSecond = document.getElementById('dataLeapSecond');
                this.dataCRC = document.getElementById('dataCRC');
                
                // 按钮元素
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                
                // 设置Canvas尺寸
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                // 绑定按钮事件
                this.startBtn.addEventListener('click', () => this.start());
                this.stopBtn.addEventListener('click', () => this.stop());
                
                // 初始化时间显示
                this.updateTimeDisplays();
                setInterval(() => this.updateTimeDisplays(), 1000);
            }
            
            resizeCanvas() {
                const display = this.canvas.parentElement;
                this.canvas.width = display.clientWidth;
                this.canvas.height = display.clientHeight;
                this.drawSignal([]); // 清空画布
            }
            
            // 开始授时
            async start() {
                if (this.isRunning) return;
                
                try {
                    // 初始化音频上下文
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.gainNode = this.audioContext.createGain();
                    this.gainNode.gain.value = 0; // 初始静音
                    this.gainNode.connect(this.audioContext.destination);
                    
                    this.isRunning = true;
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    
                    // 等待下一个整分钟
                    await this.waitForNextMinute();
                    
                    // 开始传输
                    this.transmitFrame();
                    
                } catch (error) {
                    console.error('启动ALPTP协议失败:', error);
                    this.statusDisplay.textContent = '错误: ' + error.message;
                    this.stop();
                }
            }
            
            // 停止授时
            stop() {
                this.isRunning = false;
                
                if (this.oscillator) {
                    this.oscillator.stop();
                    this.oscillator = null;
                }
                
                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }
                
                if (this.nextMinuteTimeout) {
                    clearTimeout(this.nextMinuteTimeout);
                    this.nextMinuteTimeout = null;
                }
                
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                this.statusDisplay.textContent = '授时已停止';
                this.drawSignal([]); // 清空信号显示
            }
            
            // 等待下一个整分钟
            waitForNextMinute() {
                return new Promise((resolve) => {
                    const now = new Date();
                    const secondsToNextMinute = 60 - now.getSeconds();
                    const millisecondsToNextMinute = secondsToNextMinute * 1000 - now.getMilliseconds();
                    
                    this.statusDisplay.textContent = `等待下一个整分钟开始... (${secondsToNextMinute}秒后)`;
                    
                    this.nextMinuteTimeout = setTimeout(() => {
                        this.statusDisplay.textContent = '开始传输ALPTP帧...';
                        resolve();
                    }, millisecondsToNextMinute);
                });
            }
            
            // 传输一帧数据
            transmitFrame() {
                if (!this.isRunning) return;
                
                // 生成当前时间的数据帧
                this.currentFrameData = this.generateFrameData();
                this.currentBitIndex = 0;
                
                // 开始传输
                this.transmitNextBit();
                
                // 更新UI
                this.updateDataDisplay();
                this.frameCount++;
                this.frameCountDisplay.textContent = this.frameCount;
            }
            
            // 生成当前时间的数据帧
            generateFrameData() {
                const now = new Date();
                
                // 转换为BCD格式
                const year = now.getFullYear();
                const month = now.getMonth() + 1;
                const day = now.getDate();
                const weekday = now.getDay() === 0 ? 7 : now.getDay(); // 周日为7
                const hour = now.getHours();
                const minute = now.getMinutes();
                
                // 闰秒标志 
                const leapSecond = '10'; // 假设无闰秒
                
                // 生成CRC
                const crc = this.calculateCRC([
                    ...this.toBCD(year % 100, 7),  // 年(7位)
                    ...this.toBCD(month, 8),       // 月(8位)
                    ...this.toBCD(day, 8),         // 日(8位)
                    ...this.toBCD(weekday, 8),    // 星期(8位)
                    ...this.toBCD(hour, 8),        // 时(8位)
                    ...this.toBCD(minute, 8),      // 分(8位)
                    ...leapSecond.split('').map(Number) // 闰秒标志(2位)
                ]);
                
                // 构建60位数据帧
                const frame = [
                    ...this.toBCD(year % 100, 7),  // 年(0-6位)
                    ...this.toBCD(month, 8),       // 月(7-14位)
                    ...this.toBCD(day, 8),         // 日(15-22位)
                    ...this.toBCD(weekday, 8),     // 星期(23-30位)
                    ...this.toBCD(hour, 8),        // 时(31-38位)
                    ...this.toBCD(minute, 8),      // 分(39-46位)
                    ...leapSecond.split('').map(Number), // 闰秒标志(47-48位)
                    ...crc,                        // CRC校验(49-57位)
                    1                              // m标志(58位)
                ];
                
                // 确保帧长度为60位
                while (frame.length < 60) {
                    frame.unshift(0);
                }
                
                return frame.slice(0, 60);
            }
            
            // 十进制转BCD (二进制编码的十进制)
            toBCD(number, bits) {
                let bcd = [];
                let num = number;
                
                while (num > 0 || bcd.length < bits) {
                    bcd.unshift(num % 2);
                    num = Math.floor(num / 2);
                }
                
                return bcd.slice(-bits);
            }
            
            // 校验码计算
            calculateCRC(data) {
                // 这里使用 XOR 校验
                let crc = 0;
                for (let bit of data) {
                    crc ^= bit;
                }
                
                // 返回9位 XOR
                const crcBits = [];
                for (let i = 0; i < 9; i++) {
                    crcBits.push((crc >> i) & 1);
                }
                
                return crcBits;
            }
            
            // 传输下一个比特
            transmitNextBit() {
                if (!this.isRunning || this.currentBitIndex >= 60) {
                    // 一帧传输完成，等待下一分钟
                    setTimeout(() => {
                        if (this.isRunning) {
                            this.transmitFrame();
                        }
                    }, 100); // 短暂延迟后开始下一帧
                    return;
                }
                
                const bitValue = this.currentFrameData[this.currentBitIndex];
                const isLastBit = this.currentBitIndex === 59;
                
                // 确定信号类型
                let signalType, duration;
                if (isLastBit) {
                    // m标志: 1000ms载波
                    signalType = 'm';
                    duration = 1000;
                } else if (bitValue === 0) {
                    // 0b0: 300ms载波, 700ms空闲
                    signalType = '0';
                    duration = 1000;
                } else {
                    // 0b1: 700ms载波, 300ms空闲
                    signalType = '1';
                    duration = 1000;
                }
                
                // 传输当前比特
                this.transmitBit(signalType);
                
                // 更新信号显示
                this.updateSignalDisplay(signalType, this.currentBitIndex);
                
                // 准备传输下一个比特
                this.currentBitIndex++;
                setTimeout(() => {
                    if (this.isRunning) {
                        this.transmitNextBit();
                    }
                }, duration);
            }
            
            // 传输单个比特
            transmitBit(signalType) {
                if (!this.audioContext) return;
                
                // 停止之前的振荡器
                if (this.oscillator) {
                    this.oscillator.stop();
                }
                
                // 创建新的振荡器
                this.oscillator = this.audioContext.createOscillator();
                this.oscillator.type = 'sine';
                this.oscillator.frequency.value = 1000; // 1000Hz载波
                this.oscillator.connect(this.gainNode);
                
                // 根据信号类型设置增益
                let carrierDuration, silenceDuration;
                
                switch(signalType) {
                    case '0': // 0b0: 300ms载波, 700ms空闲
                        carrierDuration = 0.3;
                        silenceDuration = 0.7;
                        break;
                    case '1': // 0b1: 700ms载波, 300ms空闲
                        carrierDuration = 0.7;
                        silenceDuration = 0.3;
                        break;
                    case 'm': // m标志: 1000ms载波
                        carrierDuration = 1.0;
                        silenceDuration = 0;
                        break;
                }
                
                const now = this.audioContext.currentTime;
                
                // 载波阶段
                this.gainNode.gain.setValueAtTime(0.5, now);
                this.gainNode.gain.setValueAtTime(0.5, now + carrierDuration);
                
                // 空闲阶段 (如果有)
                if (silenceDuration > 0) {
                    this.gainNode.gain.setValueAtTime(0, now + carrierDuration);
                }
                
                // 开始播放
                this.oscillator.start(now);
                this.oscillator.stop(now + carrierDuration + silenceDuration);
            }
            
            // 更新信号显示
            updateSignalDisplay(signalType, bitIndex) {
                // 存储信号历史用于绘制
                if (!this.signalHistory) {
                    this.signalHistory = [];
                }
                
                this.signalHistory.push({
                    type: signalType,
                    index: bitIndex
                });
                
                // 只保留最近60个信号用于显示
                if (this.signalHistory.length > 60) {
                    this.signalHistory = this.signalHistory.slice(-60);
                }
                
                // 绘制信号
                this.drawSignal(this.signalHistory);
            }
            
            // 绘制信号波形
            drawSignal(signalHistory) {
                const width = this.canvas.width;
                const height = this.canvas.height;
                
                // 清空画布
                this.ctx.fillStyle = '#0a0a1a';
                this.ctx.fillRect(0, 0, width, height);
                
                if (signalHistory.length === 0) {
                    // 绘制网格
                    this.drawGrid();
                    return;
                }
                
                // 绘制网格
                this.drawGrid();
                
                // 计算每个信号的宽度
                const signalWidth = width / 60;
                
                // 绘制信号
                signalHistory.forEach((signal, index) => {
                    const x = index * signalWidth;
                    const signalType = signal.type;
                    
                    // 设置信号颜色
                    switch(signalType) {
                        case '0':
                            this.ctx.fillStyle = '#4CAF50'; // 绿色
                            break;
                        case '1':
                            this.ctx.fillStyle = '#FF9800'; // 橙色
                            break;
                        case 'm':
                            this.ctx.fillStyle = '#F44336'; // 红色
                            break;
                    }
                    
                    // 绘制信号矩形
                    let rectWidth, rectHeight;
                    
                    switch(signalType) {
                        case '0': // 0b0: 300ms载波/700ms空闲
                            rectWidth = signalWidth * 0.3;
                            rectHeight = height * 0.6;
                            break;
                        case '1': // 0b1: 700ms载波/300ms空闲
                            rectWidth = signalWidth * 0.7;
                            rectHeight = height * 0.8;
                            break;
                        case 'm': // m标志: 1000ms载波
                            rectWidth = signalWidth;
                            rectHeight = height;
                            break;
                    }
                    
                    const y = (height - rectHeight) / 2;
                    this.ctx.fillRect(x, y, rectWidth, rectHeight);
                    
                    // 绘制信号类型标签
                    this.ctx.fillStyle = '#FFFFFF';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(signalType, x + signalWidth/2, height - 10);
                });
            }
            
            // 绘制网格
            drawGrid() {
                const width = this.canvas.width;
                const height = this.canvas.height;
                
                this.ctx.strokeStyle = 'rgba(100, 100, 150, 0.3)';
                this.ctx.lineWidth = 1;
                
                // 水平网格线
                for (let i = 0; i <= 10; i++) {
                    const y = i * height / 10;
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(width, y);
                    this.ctx.stroke();
                }
                
                // 垂直网格线 (每10位一个)
                for (let i = 0; i <= 6; i++) {
                    const x = i * width / 6;
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, height);
                    this.ctx.stroke();
                }
            }
            
            // 更新时间显示
            updateTimeDisplays() {
                const now = new Date();
                
                // 当前时间
                this.currentTimeDisplay.textContent = 
                    `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                
                // 下一帧开始时间
                const nextMinute = new Date(now);
                nextMinute.setMinutes(nextMinute.getMinutes() + 1);
                nextMinute.setSeconds(0);
                nextMinute.setMilliseconds(0);
                
                this.nextFrameTimeDisplay.textContent = 
                    `${nextMinute.getHours().toString().padStart(2, '0')}:${nextMinute.getMinutes().toString().padStart(2, '0')}:00`;
            }
            
            // 更新数据展示
            updateDataDisplay() {
                if (!this.currentFrameData) return;
                
                const now = new Date();
                
                this.dataYear.textContent = now.getFullYear();
                this.dataMonth.textContent = (now.getMonth() + 1).toString().padStart(2, '0');
                this.dataDay.textContent = now.getDate().toString().padStart(2, '0');
                
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                this.dataWeekday.textContent = `星期${weekdays[now.getDay()]}`;
                
                this.dataHour.textContent = now.getHours().toString().padStart(2, '0');
                this.dataMinute.textContent = now.getMinutes().toString().padStart(2, '0');
                this.dataLeapSecond.textContent = '无闰秒'; // 简化显示
                this.dataCRC.textContent = '有效'; // 简化显示
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            window.alptp = new ALPTPProtocol();
        });
    </script>
</body>
</html>